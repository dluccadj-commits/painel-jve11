<script>
    // =============================================
    // CONFIGURAÃ‡Ã•ES
    // =============================================

    // ðŸ”¥ NOVO LINK (formato gviz - atualiza em tempo real)
    const URL_CSV = "https://docs.google.com/spreadsheets/d/1vSUVJXJOB7UA6HNo-fv4k0fMvDSlIsXXpBh47u2FGMjZWNKKkv0mHyBW8QeskoaGGknu_N8DxkVYONC/gviz/tq?tqx=out:csv&gid=0";

    // =============================================
    // FUNÃ‡ÃƒO PRINCIPAL
    // =============================================
    async function carregarDados() {
        try {
            document.getElementById('period-info').innerHTML =
                '<span>ðŸ“… ATUALIZANDO...</span>';

            // ðŸ”¥ Anti-cache real
            const resposta = await fetch(
                URL_CSV + "&nocache=" + Date.now()
            );

            if (!resposta.ok) {
                throw new Error(`Erro HTTP: ${resposta.status}`);
            }

            const csvTexto = await resposta.text();

            const linhas = csvTexto
                .split('\n')
                .map(l => l.trim())
                .filter(l => l.length > 0);

            let inicio = 0;
            for (let i = 0; i < linhas.length; i++) {
                if (
                    linhas[i].includes('TÃ‰CNICO') ||
                    linhas[i].includes('TECNICO')
                ) {
                    inicio = i + 1;
                    break;
                }
            }

            if (inicio === 0) inicio = 2;

            const tecnicos = [];

            for (let i = inicio; i < linhas.length; i++) {
                const linha = linhas[i];
                if (!linha || linha.includes('TOTAL')) continue;

                const cols = [];
                let atual = '';
                let dentroAspas = false;

                for (let char of linha) {
                    if (char === '"') {
                        dentroAspas = !dentroAspas;
                    } else if (char === ',' && !dentroAspas) {
                        cols.push(atual);
                        atual = '';
                    } else {
                        atual += char;
                    }
                }
                cols.push(atual);

                const colunas = cols.map(c =>
                    c.replace(/^"|"$/g, '').trim()
                );

                if (colunas.length < 18) continue;

                const nome = colunas[0];
                if (!nome || nome.length < 3) continue;

                tecnicos.push({
                    nome: nome,
                    tr: colunas[1] || '',
                    dias: colunas.slice(2, 15).map(v =>
                        parseInt(v) || 0
                    ),
                    sucesso: parseInt(colunas[15]) || 0,
                    semSucesso: parseInt(colunas[16]) || 0,
                    total: parseInt(colunas[17]) || 0,
                    eficacia:
                        parseFloat(
                            (colunas[18] || '0').replace(',', '.')
                        ) || 0
                });
            }

            if (tecnicos.length > 0) {
                montarPainel(tecnicos);
                document.getElementById('period-info').innerHTML =
                    '<span>ðŸ“… DADOS ONLINE</span>';
            } else {
                throw new Error('Nenhum tÃ©cnico encontrado');
            }

        } catch (erro) {
            console.error('Erro ao carregar CSV:', erro);
            document.getElementById('period-info').innerHTML =
                '<span>ðŸ“… ERRO AO CONECTAR</span>';
        }
    }

    // =============================================
    // AUTO ATUALIZAÃ‡ÃƒO
    // =============================================

    window.addEventListener('load', carregarDados);

    // ðŸ”¥ Atualiza automaticamente a cada 30 segundos
    setInterval(carregarDados, 30000);

</script>
